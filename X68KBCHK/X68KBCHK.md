# X68000キーボードから何が送信されたか確認する
USBKBD2X68K の改変版にテレビコントロールを取り込む際に、受信側として試作したコードです。

## 押下されたキーコードを確認する
押したキーのスキャンコードを2進数でキーボードのLEDにエコーバックします。  
キーコードはInside X68000のp358 図6、もしくは、[かまださんの作成された資料](https://stdkmd.net/udcx68k/#keyboard_debugmode)を参照ください。
|bit位置|6|5|4|3|2|1|0|
|---|---|---|---|---|---|---|---|
|対応するLED|全角|ひらがな|INS|CAPS|コード入力|ローマ字|かな|

## 送出されたテレビコントロール信号を確認する
キーボードから送信されたテレビコントロール信号が何であるかをシリアルモニタに表示します。

...となる筈だったのですが、現状ではかなりの頻度で復号に失敗します。  
テレビコントロールのいくつかはトグル動作であるため、デコードの失敗率が高すぎるのは深刻な状況と言えます。

## 試したことや知見
まずはInside X68000のp365～366を確認してください。  
また、[立花@桑島技研さんの補足](https://kg68k.github.io/InsideX68000-errata/InsideX68000.html#p366_z20)にも目を通してください。

テレビコントロール信号自体はラジコンでよく見られるPPM(パルス位置変調)の一種です。  
ただし、ラジコンと異なり繰り返し送出されません。

以下の知見はArduino UNO(5V/16MHz)での結果であり、他のATmegaやATtinyでも同様な状況になると思います。

### ISR(割り込みサービスルーチン)への出入り自体が相当なオーバーヘッド
`KYRMT`の立ち上がり時刻を全て記録してから復号を試みるコードを書いてみたのですが、少なくとも750us以内に割り込みが可能な状態に復帰できませんでした。  
このため、受信した信号のかなりの部分を取りこぼします。この結果、ほぼ全ての復号に失敗します。

最終的にはATtinyなどの安価で低速なマイクロコントローラへ移行するつもりであったため、16MHz動作のATmegaを以ても機能しないこの方式は却下です。

### plusein()の開始に時間がかかる
`KYRMT`がLレベルを維持する時間を測るのが簡便です。  
現在掲示しているコードはこちらの方式になります。

しかし、`KYRMT`の立ち上がりタイミングでISRに入り、`KYRMT`がHレベルを維持する最大250us(実質100usくらい)の間にplusein()関数を開始できないことがあります。  
このため、受信した信号を頻繁に取りこぼします。この結果、半分程度の復号に失敗します。

### 外付けバッファの使用は逆効果となることがある
外付けの74LS244などで波形の整形(兼ノイズ除去)を試みましたが逆効果でした。  
入出力の波形を観測すると、ノイズ除去の効果はあるものの、Hレベル出力の維持時間が短くなってしまい、上記と相まって誤動作を頻発します。
